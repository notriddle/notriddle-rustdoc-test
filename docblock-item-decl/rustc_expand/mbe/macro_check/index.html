<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Checks that meta-variables in macro definition are correctly declared and used."><meta name="keywords" content="rust, rustlang, rust-lang, macro_check"><title>rustc_expand::mbe::macro_check - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../rustc_expand/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../rustc_expand/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module macro_check</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../rustc_expand/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press â€˜Sâ€™ to search, â€˜?â€™ for more optionsâ€¦" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">rustc_expand</a>::<wbr><a href="../index.html">mbe</a>::<wbr><a class="mod" href="#">macro_check</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/rustc_expand/mbe/macro_check.rs.html#1-652">source</a> Â· <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Checks that meta-variables in macro definition are correctly declared and used.</p>
<h2 id="what-is-checked"><a href="#what-is-checked">What is checked</a></h2><h3 id="meta-variables-must-not-be-bound-twice"><a href="#meta-variables-must-not-be-bound-twice">Meta-variables must not be bound twice</a></h3>
<div class="example-wrap compile_fail"><div class='tooltip'>â“˜</div><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { (<span class="macro-nonterminal">$x</span>:tt <span class="macro-nonterminal">$x</span>:tt) =&gt; { <span class="macro-nonterminal">$x </span>}; }</code></pre></div>
<p>This check is sound (no false-negative) and complete (no false-positive).</p>
<h3 id="meta-variables-must-not-be-free"><a href="#meta-variables-must-not-be-free">Meta-variables must not be free</a></h3>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { () =&gt; { <span class="macro-nonterminal">$x </span>}; }</code></pre></div>
<p>This check is also done at macro instantiation but only if the branch is taken.</p>
<h3 id="meta-variables-must-repeat-at-least-as-many-times-as-their-binder"><a href="#meta-variables-must-repeat-at-least-as-many-times-as-their-binder">Meta-variables must repeat at least as many times as their binder</a></h3>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { ($(<span class="macro-nonterminal">$x</span>:tt)<span class="kw-2">*</span>) =&gt; { <span class="macro-nonterminal">$x </span>}; }</code></pre></div>
<p>This check is also done at macro instantiation but only if the branch is taken.</p>
<h3 id="meta-variables-must-repeat-with-the-same-kleene-operators-as-their-binder"><a href="#meta-variables-must-repeat-with-the-same-kleene-operators-as-their-binder">Meta-variables must repeat with the same Kleene operators as their binder</a></h3>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { ($(<span class="macro-nonterminal">$x</span>:tt)+) =&gt; { $(<span class="macro-nonterminal">$x</span>)* }; }</code></pre></div>
<p>This check is not done at macro instantiation.</p>
<h2 id="disclaimer"><a href="#disclaimer">Disclaimer</a></h2>
<p>In the presence of nested macros (a macro defined in a macro), those checks may have false
positives and false negatives. We try to detect those cases by recognizing potential macro
definitions in RHSes, but nested macros may be hidden through the use of particular values of
meta-variables.</p>
<h3 id="examples-of-false-positive"><a href="#examples-of-false-positive">Examples of false positive</a></h3>
<p>False positives can come from cases where we donâ€™t recognize a nested macro, because it depends
on particular values of meta-variables. In the following example, we think both instances of
<code>$x</code> are free, which is a correct statement if <code>$name</code> is anything but <code>macro_rules</code>. But when
<code>$name</code> is <code>macro_rules</code>, like in the instantiation below, then <code>$x:tt</code> is actually a binder of
the nested macro and <code>$x</code> is bound to it.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { (<span class="macro-nonterminal">$name</span>:ident) =&gt; { <span class="macro-nonterminal">$</span><span class="macro">name! </span><span class="macro-nonterminal">bar </span>{ (<span class="macro-nonterminal">$x</span>:tt) =&gt; { <span class="macro-nonterminal">$x </span>}; } }; }
<span class="macro">foo!</span>(macro_rules);</code></pre></div>
<p>False positives can also come from cases where we think there is a nested macro while there
isnâ€™t. In the following example, we think <code>$x</code> is free, which is incorrect because <code>bar</code> is not
a nested macro since it is not evaluated as code by <code>stringify!</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { () =&gt; { <span class="macro">stringify!</span>(<span class="macro">macro_rules! </span>bar { () =&gt; { <span class="macro-nonterminal">$x </span>}; }) }; }</code></pre></div>
<h3 id="examples-of-false-negative"><a href="#examples-of-false-negative">Examples of false negative</a></h3>
<p>False negatives can come from cases where we donâ€™t recognize a meta-variable, because it depends
on particular values of meta-variables. In the following examples, we donâ€™t see that if <code>$d</code> is
instantiated with <code>$</code> then <code>$d z</code> becomes <code>$z</code> in the nested macro definition and is thus a free
meta-variable. Note however, that if <code>foo</code> is instantiated, then we would check the definition
of <code>bar</code> and would see the issue.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules! </span>foo { (<span class="macro-nonterminal">$d</span>:tt) =&gt; { <span class="macro">macro_rules! </span>bar { (<span class="macro-nonterminal">$y</span>:tt) =&gt; { <span class="macro-nonterminal">$d </span>z }; } }; }</code></pre></div>
<h2 id="how-it-is-checked"><a href="#how-it-is-checked">How it is checked</a></h2>
<p>There are 3 main functions: <code>check_binders</code>, <code>check_occurrences</code>, and <code>check_nested_macro</code>. They
all need some kind of environment.</p>
<h3 id="environments"><a href="#environments">Environments</a></h3>
<p>Environments are used to pass information.</p>
<h4 id="from-lhs-to-rhs"><a href="#from-lhs-to-rhs">From LHS to RHS</a></h4>
<p>When checking a LHS with <code>check_binders</code>, we produce (and use) an environment for binders,
namely <code>Binders</code>. This is a mapping from binder name to information about that binder: the span
of the binder for error messages and the stack of Kleene operators under which it was bound in
the LHS.</p>
<p>This environment is used by both the LHS and RHS. The LHS uses it to detect duplicate binders.
The RHS uses it to detect the other errors.</p>
<h4 id="from-outer-macro-to-inner-macro"><a href="#from-outer-macro-to-inner-macro">From outer macro to inner macro</a></h4>
<p>When checking the RHS of an outer macro and we detect a nested macro definition, we push the
current state, namely <code>MacroState</code>, to an environment of nested macro definitions. Each state
stores the LHS binders when entering the macro definition as well as the stack of Kleene
operators under which the inner macro is defined in the RHS.</p>
<p>This environment is a stack representing the nesting of macro definitions. As such, the stack of
Kleene operators under which a meta-variable is repeating is the concatenation of the stacks
stored when entering a macro definition starting from the state in which the meta-variable is
bound.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.BinderInfo.html" title="rustc_expand::mbe::macro_check::BinderInfo struct">BinderInfo</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Information attached to a meta-variable binder in LHS.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.MacroState.html" title="rustc_expand::mbe::macro_check::MacroState struct">MacroState</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">The state at which we entered a macro definition in the RHS of another macro definition.</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.NestedMacroState.html" title="rustc_expand::mbe::macro_check::NestedMacroState enum">NestedMacroState</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Represents the processed prefix of a nested macro.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.Stack.html" title="rustc_expand::mbe::macro_check::Stack enum">Stack</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Stack represented as linked list.</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.buffer_lint.html" title="rustc_expand::mbe::macro_check::buffer_lint fn">buffer_lint</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_binders.html" title="rustc_expand::mbe::macro_check::check_binders fn">check_binders</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks <code>lhs</code> as part of the LHS of a macro definition, extends <code>binders</code> with new binders, and
sets <code>valid</code> to false in case of errors.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_meta_variables.html" title="rustc_expand::mbe::macro_check::check_meta_variables fn">check_meta_variables</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks that meta-variables are used correctly in a macro definition.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_nested_macro.html" title="rustc_expand::mbe::macro_check::check_nested_macro fn">check_nested_macro</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks the body of nested macro, returns where the check stopped, and sets <code>valid</code> to false in
case of errors.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_nested_occurrences.html" title="rustc_expand::mbe::macro_check::check_nested_occurrences fn">check_nested_occurrences</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks <code>tts</code> as part of the RHS of a macro definition, tries to recognize nested macro
definitions, and sets <code>valid</code> to false in case of errors.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_occurrences.html" title="rustc_expand::mbe::macro_check::check_occurrences fn">check_occurrences</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks <code>rhs</code> as part of the RHS of a macro definition and sets <code>valid</code> to false in case of
errors.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_ops_is_prefix.html" title="rustc_expand::mbe::macro_check::check_ops_is_prefix fn">check_ops_is_prefix</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Checks that a meta-variable occurrence is valid.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.get_binder_info.html" title="rustc_expand::mbe::macro_check::get_binder_info fn">get_binder_info</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Returns the binder information of a meta-variable.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.ops_is_prefix.html" title="rustc_expand::mbe::macro_check::ops_is_prefix fn">ops_is_prefix</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Returns whether <code>binder_ops</code> is a prefix of <code>occurrence_ops</code>.</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="type" href="type.Binders.html" title="rustc_expand::mbe::macro_check::Binders type">Binders</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">An environment of meta-variables to their binder information.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="rustc_expand" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.0-dev" ></div></body></html>