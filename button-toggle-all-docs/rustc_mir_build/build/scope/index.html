<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Managing the scope stack. The scopes are tied to lexical scopes, so as we descend the THIR, we push a scope on the stack, build its contents, and then pop it off. Every scope is named by a `region::Scope`."><meta name="keywords" content="rust, rustlang, rust-lang, scope"><title>rustc_mir_build::build::scope - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../rustc_mir_build/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../rustc_mir_build/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module scope</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../rustc_mir_build/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‚ÄòS‚Äô to search, ‚Äò?‚Äô for more options‚Ä¶" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">rustc_mir_build</a>::<wbr><a href="../index.html">build</a>::<wbr><a class="mod" href="#">scope</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/rustc_mir_build/build/scope.rs.html#1-1395">source</a> ¬∑ <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Managing the scope stack. The scopes are tied to lexical scopes, so as
we descend the THIR, we push a scope on the stack, build its
contents, and then pop it off. Every scope is named by a
<code>region::Scope</code>.</p>
<h4 id="seme-regions"><a href="#seme-regions">SEME Regions</a></h4>
<p>When pushing a new <a href="struct.Scope.html" title="Scope">Scope</a>, we record the current point in the graph (a
basic block); this marks the entry to the scope. We then generate more
stuff in the control-flow graph. Whenever the scope is exited, either
via a <code>break</code> or <code>return</code> or just by fallthrough, that marks an exit
from the scope. Each lexical scope thus corresponds to a single-entry,
multiple-exit (SEME) region in the control-flow graph.</p>
<p>For now, we record the <code>region::Scope</code> to each SEME region for later reference
(see caveat in next paragraph). This is because destruction scopes are tied to
them. This may change in the future so that MIR lowering determines its own
destruction scopes.</p>
<h4 id="not-so-seme-regions"><a href="#not-so-seme-regions">Not so SEME Regions</a></h4>
<p>In the course of building matches, it sometimes happens that certain code
(namely guards) gets executed multiple times. This means that the scope lexical
scope may in fact correspond to multiple, disjoint SEME regions. So in fact our
mapping is from one scope to a vector of SEME regions. Since the SEME regions
are disjoint, the mapping is still one-to-one for the set of SEME regions that
we‚Äôre currently in.</p>
<p>Also in matches, the scopes assigned to arms are not always even SEME regions!
Each arm has a single region with one entry for each pattern. We manually
manipulate the scheduled drops in this scope to avoid dropping things multiple
times.</p>
<h4 id="drops"><a href="#drops">Drops</a></h4>
<p>The primary purpose for scopes is to insert drops: while building
the contents, we also accumulate places that need to be dropped upon
exit from each scope. This is done by calling <code>schedule_drop</code>. Once a
drop is scheduled, whenever we branch out we will insert drops of all
those places onto the outgoing edge. Note that we don‚Äôt know the full
set of scheduled drops up front, and so whenever we exit from the
scope we only drop the values scheduled thus far. For example, consider
the scope S corresponding to this loop:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">loop </span>{
    <span class="kw">let </span>x = ..;
    <span class="kw">if </span>cond { <span class="kw">break</span>; }
    <span class="kw">let </span>y = ..;
}</code></pre></div>
<p>When processing the <code>let x</code>, we will add one drop to the scope for
<code>x</code>.  The break will then insert a drop for <code>x</code>. When we process <code>let y</code>, we will add another drop (in fact, to a subscope, but let‚Äôs ignore
that for now); any later drops would also drop <code>y</code>.</p>
<h4 id="early-exit"><a href="#early-exit">Early exit</a></h4>
<p>There are numerous ‚Äúnormal‚Äù ways to early exit a scope: <code>break</code>,
<code>continue</code>, <code>return</code> (panics are handled separately). Whenever an
early exit occurs, the method <code>break_scope</code> is called. It is given the
current point in execution where the early exit occurs, as well as the
scope you want to branch to (note that all early exits from to some
other enclosing scope). <code>break_scope</code> will record the set of drops currently
scheduled in a <a href="struct.DropTree.html" title="DropTree">DropTree</a>. Later, before <code>in_breakable_scope</code> exits, the drops
will be added to the CFG.</p>
<p>Panics are handled in a similar fashion, except that the drops are added to the
MIR once the rest of the function has finished being lowered. If a terminator
can panic, call <code>diverge_from(block)</code> with the block containing the terminator
<code>block</code>.</p>
<h4 id="breakable-scopes"><a href="#breakable-scopes">Breakable scopes</a></h4>
<p>In addition to the normal scope stack, we track a loop scope stack
that contains only loops and breakable blocks. It tracks where a <code>break</code>,
<code>continue</code> or <code>return</code> should go to.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.BreakableScope.html" title="rustc_mir_build::build::scope::BreakableScope struct">BreakableScope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.DropData.html" title="rustc_mir_build::build::scope::DropData struct">DropData</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.DropIdx.html" title="rustc_mir_build::build::scope::DropIdx struct">DropIdx</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.DropTree.html" title="rustc_mir_build::build::scope::DropTree struct">DropTree</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="item-right docblock-short">A tree of drops that we have deferred lowering. It‚Äôs used for:</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.ExitScopes.html" title="rustc_mir_build::build::scope::ExitScopes struct">ExitScopes</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.GeneratorDrop.html" title="rustc_mir_build::build::scope::GeneratorDrop struct">GeneratorDrop</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.IfThenScope.html" title="rustc_mir_build::build::scope::IfThenScope struct">IfThenScope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.Scope.html" title="rustc_mir_build::build::scope::Scope struct">Scope</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.Scopes.html" title="rustc_mir_build::build::scope::Scopes struct">Scopes</a></div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.Unwind.html" title="rustc_mir_build::build::scope::Unwind struct">Unwind</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.BreakableTarget.html" title="rustc_mir_build::build::scope::BreakableTarget enum">BreakableTarget</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="item-right docblock-short">The target of an expression that breaks out of a scope</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.DropKind.html" title="rustc_mir_build::build::scope::DropKind enum">DropKind</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div></div><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.ROOT_NODE.html" title="rustc_mir_build::build::scope::ROOT_NODE constant">ROOT_NODE</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="trait" href="trait.DropTreeBuilder.html" title="rustc_mir_build::build::scope::DropTreeBuilder trait">DropTreeBuilder</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="item-right docblock-short">A trait that determined how <a href="struct.DropTree.html" title="DropTree">DropTree</a> creates its blocks and
links to any entry nodes.</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.build_scope_drops.html" title="rustc_mir_build::build::scope::build_scope_drops fn">build_scope_drops</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="item-right docblock-short">Builds drops for <code>pop_scope</code> and <code>leave_top_scope</code>.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="rustc_mir_build" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-dev" ></div></body></html>