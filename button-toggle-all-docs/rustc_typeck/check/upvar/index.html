<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Inferring borrow kinds for upvars"><meta name="keywords" content="rust, rustlang, rust-lang, upvar"><title>rustc_typeck::check::upvar - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../rustc_typeck/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../rustc_typeck/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module upvar</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../rustc_typeck/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">rustc_typeck</a>::<wbr><a href="../index.html">check</a>::<wbr><a class="mod" href="#">upvar</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/rustc_typeck/check/upvar.rs.html#1-2276">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h4 id="inferring-borrow-kinds-for-upvars"><a href="#inferring-borrow-kinds-for-upvars">Inferring borrow kinds for upvars</a></h4>
<p>Whenever there is a closure expression, we need to determine how each
upvar is used. We do this by initially assigning each upvar an
immutable “borrow kind” (see <code>ty::BorrowKind</code> for details) and then
“escalating” the kind as needed. The borrow kind proceeds according to
the following lattice:</p>

<div class="example-wrap ignore"><div class='tooltip'>ⓘ</div><pre class="rust rust-example-rendered"><code>ty::ImmBorrow -&gt; ty::UniqueImmBorrow -&gt; ty::MutBorrow</code></pre></div>
<p>So, for example, if we see an assignment <code>x = 5</code> to an upvar <code>x</code>, we
will promote its borrow kind to mutable borrow. If we see an <code>&amp;mut x</code>
we’ll do the same. Naturally, this applies not just to the upvar, but
to everything owned by <code>x</code>, so the result is the same for something
like <code>x.f = 5</code> and so on (presuming <code>x</code> is not a borrowed pointer to a
struct). These adjustments are performed in
<code>adjust_upvar_borrow_kind()</code> (you can trace backwards through the code
from there).</p>
<p>The fact that we are inferring borrow kinds as we go results in a
semi-hacky interaction with mem-categorization. In particular,
mem-categorization will query the current borrow kind as it
categorizes, and we’ll return the <em>current</em> value, but this may get
adjusted later. Therefore, in this module, we generally ignore the
borrow kind (and derived mutabilities) that are returned from
mem-categorization, since they may be inaccurate. (Another option
would be to use a unification scheme, where instead of returning a
concrete borrow kind like <code>ty::ImmBorrow</code>, we return a
<code>ty::InferBorrow(upvar_id)</code> or something like that, but this would
then mean that all later passes would have to check for these figments
and report an error, and it just seems like more mess in the end.)</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.InferBorrowKind.html" title="rustc_typeck::check::upvar::InferBorrowKind struct">InferBorrowKind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.InferBorrowKindVisitor.html" title="rustc_typeck::check::upvar::InferBorrowKindVisitor struct">InferBorrowKindVisitor</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.MigrationLintNote.html" title="rustc_typeck::check::upvar::MigrationLintNote struct">MigrationLintNote</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Intermediate format to store information needed to generate a note in the migration lint.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.MigrationWarningReason.html" title="rustc_typeck::check::upvar::MigrationWarningReason struct">MigrationWarningReason</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Reasons that we might issue a migration warning.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.NeededMigration.html" title="rustc_typeck::check::upvar::NeededMigration struct">NeededMigration</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Intermediate format to store the hir id of the root variable and a HashSet containing
information on why the root variable should be fully captured</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.PlaceAncestryRelation.html" title="rustc_typeck::check::upvar::PlaceAncestryRelation enum">PlaceAncestryRelation</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Describe the relationship between the paths of two places
eg:</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.UpvarMigrationInfo.html" title="rustc_typeck::check::upvar::UpvarMigrationInfo enum">UpvarMigrationInfo</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Intermediate format to store the hir_id pointing to the use that resulted in the
corresponding place being captured and a String which contains the captured value’s
name (i.e: a.b.c)</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.adjust_for_move_closure.html" title="rustc_typeck::check::upvar::adjust_for_move_closure fn">adjust_for_move_closure</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Truncate deref of any reference.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.adjust_for_non_move_closure.html" title="rustc_typeck::check::upvar::adjust_for_non_move_closure fn">adjust_for_non_move_closure</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Adjust closure capture just that if taking ownership of data, only move data
from enclosing stack frame.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.apply_capture_kind_on_capture_ty.html" title="rustc_typeck::check::upvar::apply_capture_kind_on_capture_ty fn">apply_capture_kind_on_capture_ty</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Returns a Ty that applies the specified capture kind on the provided capture Ty</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.construct_capture_info_string.html" title="rustc_typeck::check::upvar::construct_capture_info_string fn">construct_capture_info_string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.construct_capture_kind_reason_string.html" title="rustc_typeck::check::upvar::construct_capture_kind_reason_string fn">construct_capture_kind_reason_string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.construct_path_string.html" title="rustc_typeck::check::upvar::construct_path_string fn">construct_path_string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.construct_place_string.html" title="rustc_typeck::check::upvar::construct_place_string fn">construct_place_string</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.determine_capture_info.html" title="rustc_typeck::check::upvar::determine_capture_info fn">determine_capture_info</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Helper function to determine if we need to escalate CaptureKind from
CaptureInfo A to B and returns the escalated CaptureInfo.
(Note: CaptureInfo contains CaptureKind and an expression that led to capture it in that way)</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.determine_place_ancestry_relation.html" title="rustc_typeck::check::upvar::determine_place_ancestry_relation fn">determine_place_ancestry_relation</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Determines the Ancestry relationship of Place A relative to Place B</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.drop_location_span.html" title="rustc_typeck::check::upvar::drop_location_span fn">drop_location_span</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Returns the Span of where the value with the provided HirId would be dropped</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.enable_precise_capture.html" title="rustc_typeck::check::upvar::enable_precise_capture fn">enable_precise_capture</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Precise capture is enabled if the feature gate <code>capture_disjoint_fields</code> is enabled or if
user is using Rust Edition 2021 or higher.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.migration_suggestion_for_2229.html" title="rustc_typeck::check::upvar::migration_suggestion_for_2229 fn">migration_suggestion_for_2229</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Return a two string tuple (s1, s2)</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.restrict_capture_precision.html" title="rustc_typeck::check::upvar::restrict_capture_precision fn">restrict_capture_precision</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Truncate projections so that following rules are obeyed by the captured <code>place</code>:</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.restrict_precision_for_drop_types.html" title="rustc_typeck::check::upvar::restrict_precision_for_drop_types fn">restrict_precision_for_drop_types</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Rust doesn’t permit moving fields out of a type that implements drop</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.restrict_precision_for_unsafe.html" title="rustc_typeck::check::upvar::restrict_precision_for_unsafe fn">restrict_precision_for_unsafe</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Truncate <code>place</code> so that an <code>unsafe</code> block isn’t required to capture it.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.restrict_repr_packed_field_ref_capture.html" title="rustc_typeck::check::upvar::restrict_repr_packed_field_ref_capture fn">restrict_repr_packed_field_ref_capture</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Truncate the capture so that the place being borrowed is in accordance with RFC 1240,
which states that it’s unsafe to take a reference into a struct marked <code>repr(packed)</code>.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.should_do_rust_2021_incompatible_closure_captures_analysis.html" title="rustc_typeck::check::upvar::should_do_rust_2021_incompatible_closure_captures_analysis fn">should_do_rust_2021_incompatible_closure_captures_analysis</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.truncate_capture_for_optimization.html" title="rustc_typeck::check::upvar::truncate_capture_for_optimization fn">truncate_capture_for_optimization</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Reduces the precision of the captured place when the precision doesn’t yield any benefit from
borrow checking perspective, allowing us to save us on the size of the capture.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.truncate_place_to_len_and_update_capture_kind.html" title="rustc_typeck::check::upvar::truncate_place_to_len_and_update_capture_kind fn">truncate_place_to_len_and_update_capture_kind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Truncates <code>place</code> to have up to <code>len</code> projections.
<code>curr_mode</code> is the current required capture kind for the place.
Returns the truncated <code>place</code> and the updated required capture kind.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.var_name.html" title="rustc_typeck::check::upvar::var_name fn">var_name</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="type" href="type.InferredCaptureInformation.html" title="rustc_typeck::check::upvar::InferredCaptureInformation type">InferredCaptureInformation</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Intermediate format to store a captured <code>Place</code> and associated <code>ty::CaptureInfo</code>
during capture analysis. Information in this map feeds into the minimum capture
analysis pass.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="rustc_typeck" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-dev" ></div></body></html>