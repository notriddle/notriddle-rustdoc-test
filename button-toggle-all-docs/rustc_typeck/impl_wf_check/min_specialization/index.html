<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Minimal Specialization"><meta name="keywords" content="rust, rustlang, rust-lang, min_specialization"><title>rustc_typeck::impl_wf_check::min_specialization - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../rustc_typeck/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../rustc_typeck/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module min_specialization</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#functions">Functions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../rustc_typeck/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">rustc_typeck</a>::<wbr><a href="../index.html">impl_wf_check</a>::<wbr><a class="mod" href="#">min_specialization</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/rustc_typeck/impl_wf_check/min_specialization.rs.html#1-444">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="minimal-specialization"><a href="#minimal-specialization">Minimal Specialization</a></h2>
<p>This module contains the checks for sound specialization used when the
<code>min_specialization</code> feature is enabled. This requires that the impl is
<em>always applicable</em>.</p>
<p>If <code>impl1</code> specializes <code>impl2</code> then <code>impl1</code> is always applicable if we know
that all the bounds of <code>impl2</code> are satisfied, and all of the bounds of
<code>impl1</code> are satisfied for some choice of lifetimes then we know that
<code>impl1</code> applies for any choice of lifetimes.</p>
<h3 id="basic-approach"><a href="#basic-approach">Basic approach</a></h3>
<p>To enforce this requirement on specializations we take the following
approach:</p>
<ol>
<li>Match up the substs for <code>impl2</code> so that the implemented trait and
self-type match those for <code>impl1</code>.</li>
<li>Check for any direct use of <code>'static</code> in the substs of <code>impl2</code>.</li>
<li>Check that all of the generic parameters of <code>impl1</code> occur at most once
in the <em>unconstrained</em> substs for <code>impl2</code>. A parameter is constrained if
its value is completely determined by an associated type projection
predicate.</li>
<li>Check that all predicates on <code>impl1</code> either exist on <code>impl2</code> (after
matching substs), or are well-formed predicates for the trait’s type
arguments.</li>
</ol>
<h3 id="example"><a href="#example">Example</a></h3>
<p>Suppose we have the following always applicable impl:</p>

<div class="example-wrap ignore"><div class='tooltip'>ⓘ</div><pre class="rust rust-example-rendered"><code><span class="kw">impl</span>&lt;T&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>std::vec::IntoIter&lt;T&gt; { <span class="comment">/* specialized impl */ </span>}
<span class="kw">impl</span>&lt;T, I: Iterator&lt;Item=T&gt;&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>I { <span class="comment">/* default impl */ </span>}</code></pre></div>
<p>We get that the subst for <code>impl2</code> are <code>[T, std::vec::IntoIter&lt;T&gt;]</code>. <code>T</code> is
constrained to be <code>&lt;I as Iterator&gt;::Item</code>, so we check only
<code>std::vec::IntoIter&lt;T&gt;</code> for repeated parameters, which it doesn’t have. The
predicates of <code>impl1</code> are only <code>T: Sized</code>, which is also a predicate of
<code>impl2</code>. So this specialization is sound.</p>
<h3 id="extensions"><a href="#extensions">Extensions</a></h3>
<p>Unfortunately not all specializations in the standard library are allowed
by this. So there are two extensions to these rules that allow specializing
on some traits: that is, using them as bounds on the specializing impl,
even when they don’t occur in the base impl.</p>
<h4 id="rustc_specialization_trait"><a href="#rustc_specialization_trait">rustc_specialization_trait</a></h4>
<p>If a trait is always applicable, then it’s sound to specialize on it. We
check trait is always applicable in the same way as impls, except that step
4 is now “all predicates on <code>impl1</code> are always applicable”. We require that
<code>specialization</code> or <code>min_specialization</code> is enabled to implement these
traits.</p>
<h4 id="rustc_unsafe_specialization_marker"><a href="#rustc_unsafe_specialization_marker">rustc_unsafe_specialization_marker</a></h4>
<p>There are also some specialization on traits with no methods, including the
stable <code>FusedIterator</code> trait. We allow marking marker traits with an
unstable attribute that means we ignore them in point 3 of the checks
above. This is unsound, in the sense that the specialized impl may be used
when it doesn’t apply, but we allow it in the short term since it can’t
cause use after frees with purely safe code in the same way as specializing
on traits with methods can.</p>
</div></details><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_always_applicable.html" title="rustc_typeck::impl_wf_check::min_specialization::check_always_applicable fn">check_always_applicable</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Check that <code>impl1</code> is a sound specialization</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_duplicate_params.html" title="rustc_typeck::impl_wf_check::min_specialization::check_duplicate_params fn">check_duplicate_params</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Check that parameters of the derived impl don’t occur more than once in the
equated substs of the base impl.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_min_specialization.html" title="rustc_typeck::impl_wf_check::min_specialization::check_min_specialization fn">check_min_specialization</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_predicates.html" title="rustc_typeck::impl_wf_check::min_specialization::check_predicates fn">check_predicates</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Check whether predicates on the specializing impl (<code>impl1</code>) are allowed.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_specialization_on.html" title="rustc_typeck::impl_wf_check::min_specialization::check_specialization_on fn">check_specialization_on</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.check_static_lifetimes.html" title="rustc_typeck::impl_wf_check::min_specialization::check_static_lifetimes fn">check_static_lifetimes</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Check that <code>'static</code> lifetimes are not introduced by the specializing impl.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.get_impl_substs.html" title="rustc_typeck::impl_wf_check::min_specialization::get_impl_substs fn">get_impl_substs</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Given a specializing impl <code>impl1</code>, and the base impl <code>impl2</code>, returns two
substitutions <code>(S1, S2)</code> that equate their trait references. The returned
types are expressed in terms of the generics of <code>impl1</code>.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.parent_specialization_node.html" title="rustc_typeck::impl_wf_check::min_specialization::parent_specialization_node fn">parent_specialization_node</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.trait_predicate_kind.html" title="rustc_typeck::impl_wf_check::min_specialization::trait_predicate_kind fn">trait_predicate_kind</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.unconstrained_parent_impl_substs.html" title="rustc_typeck::impl_wf_check::min_specialization::unconstrained_parent_impl_substs fn">unconstrained_parent_impl_substs</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="item-right docblock-short">Returns a list of all of the unconstrained subst of the given impl.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="rustc_typeck" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-dev" ></div></body></html>