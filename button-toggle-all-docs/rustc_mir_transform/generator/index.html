<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This is the implementation of the pass which transforms generators into state machines."><meta name="keywords" content="rust, rustlang, rust-lang, generator"><title>rustc_mir_transform::generator - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../rustc_mir_transform/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../rustc_mir_transform/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module generator</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../rustc_mir_transform/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press â€˜Sâ€™ to search, â€˜?â€™ for more optionsâ€¦" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../index.html">rustc_mir_transform</a>::<wbr><a class="mod" href="#">generator</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../src/rustc_mir_transform/generator.rs.html#1-1503">source</a> Â· <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This is the implementation of the pass which transforms generators into state machines.</p>
<p>MIR generation for generators creates a function which has a self argument which
passes by value. This argument is effectively a generator type which only contains upvars and
is only used for this argument inside the MIR for the generator.
It is passed by value to enable upvars to be moved out of it. Drop elaboration runs on that
MIR before this pass and creates drop flags for MIR locals.
It will also drop the generator argument (which only consists of upvars) if any of the upvars
are moved out of. This pass elaborates the drops of upvars / generator argument in the case
that none of the upvars were moved out of. This is because we cannot have any drops of this
generator in the MIR, since it is used to create the drop glue for the generator. Weâ€™d get
infinite recursion otherwise.</p>
<p>This pass creates the implementation for the Generator::resume function and the drop shim
for the generator based on the MIR input. It converts the generator argument from Self to
&amp;mut Self adding derefs in the MIR as needed. It computes the final layout of the generator
struct which looks like this:
First upvars are stored
It is followed by the generator state field.
Then finally the MIR locals which are live across a suspension point are stored.
<code>ignore (illustrative) struct Generator { upvars..., state: u32, mir_locals..., } </code>
This pass computes the meaning of the state field and the MIR locals which are live
across a suspension point. There are however three hardcoded generator states:
0 - Generator have not been resumed yet
1 - Generator has returned / is completed
2 - Generator has been poisoned</p>
<p>It also rewrites <code>return x</code> and <code>yield y</code> as setting a new generator state and returning
GeneratorState::Complete(x) and GeneratorState::Yielded(y) respectively.
MIR locals which are live across a suspension point are moved to the generator struct
with references to them being updated with references to the generator struct.</p>
<p>The pass creates two functions which have a switch on the generator state giving
the action to take.</p>
<p>One of them is the implementation of Generator::resume.
For generators with state 0 (unresumed) it starts the execution of the generator.
For generators with state 1 (returned) and state 2 (poisoned) it panics.
Otherwise it continues the execution from the last suspension point.</p>
<p>The other function is the drop glue for the generator.
For generators with state 0 (unresumed) it drops the upvars of the generator.
For generators with state 1 (returned) and state 2 (poisoned) it does nothing.
Otherwise it drops all the values in scope at the last suspension point.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.DerefArgVisitor.html" title="rustc_mir_transform::generator::DerefArgVisitor struct">DerefArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.EnsureGeneratorFieldAssignmentsNeverAlias.html" title="rustc_mir_transform::generator::EnsureGeneratorFieldAssignmentsNeverAlias struct">EnsureGeneratorFieldAssignmentsNeverAlias</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Looks for any assignments between locals (e.g., <code>_4 = _5</code>) that will both be converted to fields
in the generator state machine but whose storage is not marked as conflicting</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.GeneratorSavedLocals.html" title="rustc_mir_transform::generator::GeneratorSavedLocals struct">GeneratorSavedLocals</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">The set of <code>Local</code>s that must be saved across yield points.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.LivenessInfo.html" title="rustc_mir_transform::generator::LivenessInfo struct">LivenessInfo</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.PinArgVisitor.html" title="rustc_mir_transform::generator::PinArgVisitor struct">PinArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.RenameLocalVisitor.html" title="rustc_mir_transform::generator::RenameLocalVisitor struct">RenameLocalVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.StateTransform.html" title="rustc_mir_transform::generator::StateTransform struct">StateTransform</a></div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.StorageConflictVisitor.html" title="rustc_mir_transform::generator::StorageConflictVisitor struct">StorageConflictVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.SuspensionPoint.html" title="rustc_mir_transform::generator::SuspensionPoint struct">SuspensionPoint</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">A <code>yield</code> point in the generator.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="struct" href="struct.TransformVisitor.html" title="rustc_mir_transform::generator::TransformVisitor struct">TransformVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="enum" href="enum.Operation.html" title="rustc_mir_transform::generator::Operation enum">Operation</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">An operation that can be performed on a generator.</div></div></div><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.POISONED.html" title="rustc_mir_transform::generator::POISONED constant">POISONED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Generator has panicked and is poisoned.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.RESERVED_VARIANTS.html" title="rustc_mir_transform::generator::RESERVED_VARIANTS constant">RESERVED_VARIANTS</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Number of variants to reserve in generator state. Corresponds to
<code>UNRESUMED</code> (beginning of a generator) and <code>RETURNED</code>/<code>POISONED</code>
(end of a generator) states.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.RETURNED.html" title="rustc_mir_transform::generator::RETURNED constant">RETURNED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Generator has returned / is completed.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.SELF_ARG.html" title="rustc_mir_transform::generator::SELF_ARG constant">SELF_ARG</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="constant" href="constant.UNRESUMED.html" title="rustc_mir_transform::generator::UNRESUMED constant">UNRESUMED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Generator has not been resumed yet.</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.can_return.html" title="rustc_mir_transform::generator::can_return fn">can_return</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.can_unwind.html" title="rustc_mir_transform::generator::can_unwind fn">can_unwind</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.compute_layout.html" title="rustc_mir_transform::generator::compute_layout fn">compute_layout</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.compute_storage_conflicts.html" title="rustc_mir_transform::generator::compute_storage_conflicts fn">compute_storage_conflicts</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">For every saved local, looks for which locals are StorageLive at the same
time. Generates a bitset for every local of all the other locals that may be
StorageLive simultaneously with that local. This is used in the layout
computation; see <code>GeneratorLayout</code> for more.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.create_cases.html" title="rustc_mir_transform::generator::create_cases fn">create_cases</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.create_generator_drop_shim.html" title="rustc_mir_transform::generator::create_generator_drop_shim fn">create_generator_drop_shim</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.create_generator_resume_function.html" title="rustc_mir_transform::generator::create_generator_resume_function fn">create_generator_resume_function</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.elaborate_generator_drops.html" title="rustc_mir_transform::generator::elaborate_generator_drops fn">elaborate_generator_drops</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.insert_clean_drop.html" title="rustc_mir_transform::generator::insert_clean_drop fn">insert_clean_drop</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.insert_panic_block.html" title="rustc_mir_transform::generator::insert_panic_block fn">insert_panic_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.insert_switch.html" title="rustc_mir_transform::generator::insert_switch fn">insert_switch</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Replaces the entry point of <code>body</code> with a block that switches on the generator discriminant and
dispatches to blocks according to <code>cases</code>.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.insert_term_block.html" title="rustc_mir_transform::generator::insert_term_block fn">insert_term_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.locals_live_across_suspend_points.html" title="rustc_mir_transform::generator::locals_live_across_suspend_points fn">locals_live_across_suspend_points</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.make_generator_state_argument_indirect.html" title="rustc_mir_transform::generator::make_generator_state_argument_indirect fn">make_generator_state_argument_indirect</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.make_generator_state_argument_pinned.html" title="rustc_mir_transform::generator::make_generator_state_argument_pinned fn">make_generator_state_argument_pinned</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.replace_base.html" title="rustc_mir_transform::generator::replace_base fn">replace_base</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.replace_local.html" title="rustc_mir_transform::generator::replace_local fn">replace_local</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Allocates a new local and replaces all references of <code>local</code> with it. Returns the new local.</div></div><div class="item-row"><div class="item-left unstable module-item"><a class="fn" href="fn.sanitize_witness.html" title="rustc_mir_transform::generator::sanitize_witness fn">sanitize_witness</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="item-right docblock-short">Validates the typeck view of the generator against the actual set of types saved between
yield points.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="rustc_mir_transform" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-dev" ></div></body></html>