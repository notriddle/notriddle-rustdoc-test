<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `library/test/src/cli.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>cli.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize1.65.0.css"><link rel="stylesheet" href="../../rustdoc1.65.0.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu1.65.0.css" disabled><link rel="stylesheet" href="../../dark1.65.0.css" disabled><link rel="stylesheet" href="../../light1.65.0.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage1.65.0.js"></script><script defer src="../../source-script1.65.0.js"></script><script defer src="../../source-files1.65.0.js"></script><script defer src="../../main1.65.0.js"></script><noscript><link rel="stylesheet" href="../../noscript1.65.0.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x161.65.0.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x321.65.0.png"><link rel="icon" type="image/svg+xml" href="../../favicon1.65.0.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../test/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo1.65.0.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../test/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo1.65.0.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../test/index.html"><img class="rust-logo" src="../../rust-logo1.65.0.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel1.65.0.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
</pre><pre class="rust"><code><span class="doccomment">//! Module converting command-line arguments into test configuration.

</span><span class="kw">use </span>std::env;
<span class="kw">use </span>std::path::PathBuf;

<span class="kw">use </span><span class="kw">super</span>::helpers::isatty;
<span class="kw">use </span><span class="kw">super</span>::options::{ColorConfig, Options, OutputFormat, RunIgnored};
<span class="kw">use </span><span class="kw">super</span>::time::TestTimeOptions;

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>TestOpts {
    <span class="kw">pub </span>list: bool,
    <span class="kw">pub </span>filters: Vec&lt;String&gt;,
    <span class="kw">pub </span>filter_exact: bool,
    <span class="kw">pub </span>force_run_in_process: bool,
    <span class="kw">pub </span>exclude_should_panic: bool,
    <span class="kw">pub </span>run_ignored: RunIgnored,
    <span class="kw">pub </span>run_tests: bool,
    <span class="kw">pub </span>bench_benchmarks: bool,
    <span class="kw">pub </span>logfile: <span class="prelude-ty">Option</span>&lt;PathBuf&gt;,
    <span class="kw">pub </span>nocapture: bool,
    <span class="kw">pub </span>color: ColorConfig,
    <span class="kw">pub </span>format: OutputFormat,
    <span class="kw">pub </span>shuffle: bool,
    <span class="kw">pub </span>shuffle_seed: <span class="prelude-ty">Option</span>&lt;u64&gt;,
    <span class="kw">pub </span>test_threads: <span class="prelude-ty">Option</span>&lt;usize&gt;,
    <span class="kw">pub </span>skip: Vec&lt;String&gt;,
    <span class="kw">pub </span>time_options: <span class="prelude-ty">Option</span>&lt;TestTimeOptions&gt;,
    <span class="kw">pub </span>options: Options,
}

<span class="kw">impl </span>TestOpts {
    <span class="kw">pub fn </span>use_color(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="kw">match </span><span class="self">self</span>.color {
            ColorConfig::AutoColor =&gt; !<span class="self">self</span>.nocapture &amp;&amp; isatty::stdout_isatty(),
            ColorConfig::AlwaysColor =&gt; <span class="bool-val">true</span>,
            ColorConfig::NeverColor =&gt; <span class="bool-val">false</span>,
        }
    }
}

<span class="doccomment">/// Result of parsing the options.
</span><span class="kw">pub type </span>OptRes = <span class="prelude-ty">Result</span>&lt;TestOpts, String&gt;;
<span class="doccomment">/// Result of parsing the option part.
</span><span class="kw">type </span>OptPartRes&lt;T&gt; = <span class="prelude-ty">Result</span>&lt;T, String&gt;;

<span class="kw">fn </span>optgroups() -&gt; getopts::Options {
    <span class="kw">let </span><span class="kw-2">mut </span>opts = getopts::Options::new();
    opts.optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;include-ignored&quot;</span>, <span class="string">&quot;Run ignored and not ignored tests&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;ignored&quot;</span>, <span class="string">&quot;Run only ignored tests&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;force-run-in-process&quot;</span>, <span class="string">&quot;Forces tests to run in-process when panic=abort&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;exclude-should-panic&quot;</span>, <span class="string">&quot;Excludes tests marked as should_panic&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;Run tests and not benchmarks&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;bench&quot;</span>, <span class="string">&quot;Run benchmarks instead of tests&quot;</span>)
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;List all tests and benchmarks&quot;</span>)
        .optflag(<span class="string">&quot;h&quot;</span>, <span class="string">&quot;help&quot;</span>, <span class="string">&quot;Display this message&quot;</span>)
        .optopt(<span class="string">&quot;&quot;</span>, <span class="string">&quot;logfile&quot;</span>, <span class="string">&quot;Write logs to the specified file&quot;</span>, <span class="string">&quot;PATH&quot;</span>)
        .optflag(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;nocapture&quot;</span>,
            <span class="string">&quot;don&#39;t capture stdout/stderr of each \
             task, allow printing directly&quot;</span>,
        )
        .optopt(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;test-threads&quot;</span>,
            <span class="string">&quot;Number of threads used for running tests \
             in parallel&quot;</span>,
            <span class="string">&quot;n_threads&quot;</span>,
        )
        .optmulti(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;skip&quot;</span>,
            <span class="string">&quot;Skip tests whose names contain FILTER (this flag can \
             be used multiple times)&quot;</span>,
            <span class="string">&quot;FILTER&quot;</span>,
        )
        .optflag(
            <span class="string">&quot;q&quot;</span>,
            <span class="string">&quot;quiet&quot;</span>,
            <span class="string">&quot;Display one character per test instead of one line. \
             Alias to --format=terse&quot;</span>,
        )
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;exact&quot;</span>, <span class="string">&quot;Exactly match filters rather than by substring&quot;</span>)
        .optopt(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;color&quot;</span>,
            <span class="string">&quot;Configure coloring of output:
            auto   = colorize if stdout is a tty and tests are run on serially (default);
            always = always colorize output;
            never  = never colorize output;&quot;</span>,
            <span class="string">&quot;auto|always|never&quot;</span>,
        )
        .optopt(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;format&quot;</span>,
            <span class="string">&quot;Configure formatting of output:
            pretty = Print verbose output;
            terse  = Display one character per test;
            json   = Output a json document;
            junit  = Output a JUnit document&quot;</span>,
            <span class="string">&quot;pretty|terse|json|junit&quot;</span>,
        )
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;show-output&quot;</span>, <span class="string">&quot;Show captured stdout of successful tests&quot;</span>)
        .optopt(
            <span class="string">&quot;Z&quot;</span>,
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;Enable nightly-only flags:
            unstable-options = Allow use of experimental features&quot;</span>,
            <span class="string">&quot;unstable-options&quot;</span>,
        )
        .optflag(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;report-time&quot;</span>,
            <span class="string">&quot;Show execution time of each test.

            Threshold values for colorized output can be configured via
            `RUST_TEST_TIME_UNIT`, `RUST_TEST_TIME_INTEGRATION` and
            `RUST_TEST_TIME_DOCTEST` environment variables.

            Expected format of environment variable is `VARIABLE=WARN_TIME,CRITICAL_TIME`.
            Durations must be specified in milliseconds, e.g. `500,2000` means that the warn time
            is 0.5 seconds, and the critical time is 2 seconds.

            Not available for --format=terse&quot;</span>,
        )
        .optflag(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;ensure-time&quot;</span>,
            <span class="string">&quot;Treat excess of the test execution time limit as error.

            Threshold values for this option can be configured via
            `RUST_TEST_TIME_UNIT`, `RUST_TEST_TIME_INTEGRATION` and
            `RUST_TEST_TIME_DOCTEST` environment variables.

            Expected format of environment variable is `VARIABLE=WARN_TIME,CRITICAL_TIME`.

            `CRITICAL_TIME` here means the limit that should not be exceeded by test.
            &quot;</span>,
        )
        .optflag(<span class="string">&quot;&quot;</span>, <span class="string">&quot;shuffle&quot;</span>, <span class="string">&quot;Run tests in random order&quot;</span>)
        .optopt(
            <span class="string">&quot;&quot;</span>,
            <span class="string">&quot;shuffle-seed&quot;</span>,
            <span class="string">&quot;Run tests in random order; seed the random number generator with SEED&quot;</span>,
            <span class="string">&quot;SEED&quot;</span>,
        );
    opts
}

<span class="kw">fn </span>usage(binary: <span class="kw-2">&amp;</span>str, options: <span class="kw-2">&amp;</span>getopts::Options) {
    <span class="kw">let </span>message = <span class="macro">format!</span>(<span class="string">&quot;Usage: {binary} [OPTIONS] [FILTERS...]&quot;</span>);
    <span class="macro">println!</span>(
        <span class="string">r#&quot;{usage}

The FILTER string is tested against the name of all tests, and only those
tests whose names contain the filter are run. Multiple filter strings may
be passed, which will run all tests matching any of the filters.

By default, all tests are run in parallel. This can be altered with the
--test-threads flag or the RUST_TEST_THREADS environment variable when running
tests (set it to 1).

By default, the tests are run in alphabetical order. Use --shuffle or set
RUST_TEST_SHUFFLE to run the tests in random order. Pass the generated
&quot;shuffle seed&quot; to --shuffle-seed (or set RUST_TEST_SHUFFLE_SEED) to run the
tests in the same order again. Note that --shuffle and --shuffle-seed do not
affect whether the tests are run in parallel.

All tests have their standard output and standard error captured by default.
This can be overridden with the --nocapture flag or setting RUST_TEST_NOCAPTURE
environment variable to a value other than &quot;0&quot;. Logging is not captured by default.

Test Attributes:

    `#[test]`        - Indicates a function is a test to be run. This function
                       takes no arguments.
    `#[bench]`       - Indicates a function is a benchmark to be run. This
                       function takes one argument (test::Bencher).
    `#[should_panic]` - This function (also labeled with `#[test]`) will only pass if
                        the code causes a panic (an assertion failure or panic!)
                        A message may be provided, which the failure string must
                        contain: #[should_panic(expected = &quot;foo&quot;)].
    `#[ignore]`       - When applied to a function which is already attributed as a
                        test, then the test runner will ignore these tests during
                        normal test runs. Running with --ignored or --include-ignored will run
                        these tests.&quot;#</span>,
        usage = options.usage(<span class="kw-2">&amp;</span>message)
    );
}

<span class="doccomment">/// Parses command line arguments into test options.
/// Returns `None` if help was requested (since we only show help message and don&#39;t run tests),
/// returns `Some(Err(..))` if provided arguments are incorrect,
/// otherwise creates a `TestOpts` object and returns it.
</span><span class="kw">pub fn </span>parse_opts(args: <span class="kw-2">&amp;</span>[String]) -&gt; <span class="prelude-ty">Option</span>&lt;OptRes&gt; {
    <span class="comment">// Parse matches.
    </span><span class="kw">let </span>opts = optgroups();
    <span class="kw">let </span>binary = args.get(<span class="number">0</span>).map(|c| <span class="kw-2">&amp;**</span>c).unwrap_or(<span class="string">&quot;...&quot;</span>);
    <span class="kw">let </span>args = args.get(<span class="number">1</span>..).unwrap_or(args);
    <span class="kw">let </span>matches = <span class="kw">match </span>opts.parse(args) {
        <span class="prelude-val">Ok</span>(m) =&gt; m,
        <span class="prelude-val">Err</span>(f) =&gt; <span class="kw">return </span><span class="prelude-val">Some</span>(<span class="prelude-val">Err</span>(f.to_string())),
    };

    <span class="comment">// Check if help was requested.
    </span><span class="kw">if </span>matches.opt_present(<span class="string">&quot;h&quot;</span>) {
        <span class="comment">// Show help and do nothing more.
        </span>usage(binary, <span class="kw-2">&amp;</span>opts);
        <span class="kw">return </span><span class="prelude-val">None</span>;
    }

    <span class="comment">// Actually parse the opts.
    </span><span class="kw">let </span>opts_result = parse_opts_impl(matches);

    <span class="prelude-val">Some</span>(opts_result)
}

<span class="comment">// Gets the option value and checks if unstable features are enabled.
</span><span class="macro">macro_rules! </span>unstable_optflag {
    (<span class="macro-nonterminal">$matches</span>:ident, <span class="macro-nonterminal">$allow_unstable</span>:ident, <span class="macro-nonterminal">$option_name</span>:literal) =&gt; {{
        <span class="kw">let </span>opt = <span class="macro-nonterminal">$matches</span>.opt_present(<span class="macro-nonterminal">$option_name</span>);
        <span class="kw">if </span>!<span class="macro-nonterminal">$allow_unstable </span>&amp;&amp; opt {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;The \&quot;{}\&quot; flag is only accepted on the nightly compiler with -Z unstable-options&quot;</span>,
                <span class="macro-nonterminal">$option_name
            </span>));
        }

        opt
    }};
}

<span class="comment">// Gets the option value and checks if unstable features are enabled.
</span><span class="macro">macro_rules! </span>unstable_optopt {
    (<span class="macro-nonterminal">$matches</span>:ident, <span class="macro-nonterminal">$allow_unstable</span>:ident, <span class="macro-nonterminal">$option_name</span>:literal) =&gt; {{
        <span class="kw">let </span>opt = <span class="macro-nonterminal">$matches</span>.opt_str(<span class="macro-nonterminal">$option_name</span>);
        <span class="kw">if </span>!<span class="macro-nonterminal">$allow_unstable </span>&amp;&amp; opt.is_some() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;The \&quot;{}\&quot; option is only accepted on the nightly compiler with -Z unstable-options&quot;</span>,
                <span class="macro-nonterminal">$option_name
            </span>));
        }

        opt
    }};
}

<span class="comment">// Implementation of `parse_opts` that doesn&#39;t care about help message
// and returns a `Result`.
</span><span class="kw">fn </span>parse_opts_impl(matches: getopts::Matches) -&gt; OptRes {
    <span class="kw">let </span>allow_unstable = get_allow_unstable(<span class="kw-2">&amp;</span>matches)<span class="question-mark">?</span>;

    <span class="comment">// Unstable flags
    </span><span class="kw">let </span>force_run_in_process = <span class="macro">unstable_optflag!</span>(matches, allow_unstable, <span class="string">&quot;force-run-in-process&quot;</span>);
    <span class="kw">let </span>exclude_should_panic = <span class="macro">unstable_optflag!</span>(matches, allow_unstable, <span class="string">&quot;exclude-should-panic&quot;</span>);
    <span class="kw">let </span>time_options = get_time_options(<span class="kw-2">&amp;</span>matches, allow_unstable)<span class="question-mark">?</span>;
    <span class="kw">let </span>shuffle = get_shuffle(<span class="kw-2">&amp;</span>matches, allow_unstable)<span class="question-mark">?</span>;
    <span class="kw">let </span>shuffle_seed = get_shuffle_seed(<span class="kw-2">&amp;</span>matches, allow_unstable)<span class="question-mark">?</span>;

    <span class="kw">let </span>include_ignored = matches.opt_present(<span class="string">&quot;include-ignored&quot;</span>);
    <span class="kw">let </span>quiet = matches.opt_present(<span class="string">&quot;quiet&quot;</span>);
    <span class="kw">let </span>exact = matches.opt_present(<span class="string">&quot;exact&quot;</span>);
    <span class="kw">let </span>list = matches.opt_present(<span class="string">&quot;list&quot;</span>);
    <span class="kw">let </span>skip = matches.opt_strs(<span class="string">&quot;skip&quot;</span>);

    <span class="kw">let </span>bench_benchmarks = matches.opt_present(<span class="string">&quot;bench&quot;</span>);
    <span class="kw">let </span>run_tests = !bench_benchmarks || matches.opt_present(<span class="string">&quot;test&quot;</span>);

    <span class="kw">let </span>logfile = get_log_file(<span class="kw-2">&amp;</span>matches)<span class="question-mark">?</span>;
    <span class="kw">let </span>run_ignored = get_run_ignored(<span class="kw-2">&amp;</span>matches, include_ignored)<span class="question-mark">?</span>;
    <span class="kw">let </span>filters = matches.free.clone();
    <span class="kw">let </span>nocapture = get_nocapture(<span class="kw-2">&amp;</span>matches)<span class="question-mark">?</span>;
    <span class="kw">let </span>test_threads = get_test_threads(<span class="kw-2">&amp;</span>matches)<span class="question-mark">?</span>;
    <span class="kw">let </span>color = get_color_config(<span class="kw-2">&amp;</span>matches)<span class="question-mark">?</span>;
    <span class="kw">let </span>format = get_format(<span class="kw-2">&amp;</span>matches, quiet, allow_unstable)<span class="question-mark">?</span>;

    <span class="kw">let </span>options = Options::new().display_output(matches.opt_present(<span class="string">&quot;show-output&quot;</span>));

    <span class="kw">let </span>test_opts = TestOpts {
        list,
        filters,
        filter_exact: exact,
        force_run_in_process,
        exclude_should_panic,
        run_ignored,
        run_tests,
        bench_benchmarks,
        logfile,
        nocapture,
        color,
        format,
        shuffle,
        shuffle_seed,
        test_threads,
        skip,
        time_options,
        options,
    };

    <span class="prelude-val">Ok</span>(test_opts)
}

<span class="comment">// FIXME: Copied from librustc_ast until linkage errors are resolved. Issue #47566
</span><span class="kw">fn </span>is_nightly() -&gt; bool {
    <span class="comment">// Whether this is a feature-staged build, i.e., on the beta or stable channel
    </span><span class="kw">let </span>disable_unstable_features = <span class="macro">option_env!</span>(<span class="string">&quot;CFG_DISABLE_UNSTABLE_FEATURES&quot;</span>).is_some();
    <span class="comment">// Whether we should enable unstable features for bootstrapping
    </span><span class="kw">let </span>bootstrap = env::var(<span class="string">&quot;RUSTC_BOOTSTRAP&quot;</span>).is_ok();

    bootstrap || !disable_unstable_features
}

<span class="comment">// Gets the CLI options associated with `report-time` feature.
</span><span class="kw">fn </span>get_time_options(
    matches: <span class="kw-2">&amp;</span>getopts::Matches,
    allow_unstable: bool,
) -&gt; OptPartRes&lt;<span class="prelude-ty">Option</span>&lt;TestTimeOptions&gt;&gt; {
    <span class="kw">let </span>report_time = <span class="macro">unstable_optflag!</span>(matches, allow_unstable, <span class="string">&quot;report-time&quot;</span>);
    <span class="kw">let </span>ensure_test_time = <span class="macro">unstable_optflag!</span>(matches, allow_unstable, <span class="string">&quot;ensure-time&quot;</span>);

    <span class="comment">// If `ensure-test-time` option is provided, time output is enforced,
    // so user won&#39;t be confused if any of tests will silently fail.
    </span><span class="kw">let </span>options = <span class="kw">if </span>report_time || ensure_test_time {
        <span class="prelude-val">Some</span>(TestTimeOptions::new_from_env(ensure_test_time))
    } <span class="kw">else </span>{
        <span class="prelude-val">None
    </span>};

    <span class="prelude-val">Ok</span>(options)
}

<span class="kw">fn </span>get_shuffle(matches: <span class="kw-2">&amp;</span>getopts::Matches, allow_unstable: bool) -&gt; OptPartRes&lt;bool&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>shuffle = <span class="macro">unstable_optflag!</span>(matches, allow_unstable, <span class="string">&quot;shuffle&quot;</span>);
    <span class="kw">if </span>!shuffle &amp;&amp; allow_unstable {
        shuffle = <span class="kw">match </span>env::var(<span class="string">&quot;RUST_TEST_SHUFFLE&quot;</span>) {
            <span class="prelude-val">Ok</span>(val) =&gt; <span class="kw-2">&amp;</span>val != <span class="string">&quot;0&quot;</span>,
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="bool-val">false</span>,
        };
    }

    <span class="prelude-val">Ok</span>(shuffle)
}

<span class="kw">fn </span>get_shuffle_seed(matches: <span class="kw-2">&amp;</span>getopts::Matches, allow_unstable: bool) -&gt; OptPartRes&lt;<span class="prelude-ty">Option</span>&lt;u64&gt;&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>shuffle_seed = <span class="kw">match </span><span class="macro">unstable_optopt!</span>(matches, allow_unstable, <span class="string">&quot;shuffle-seed&quot;</span>) {
        <span class="prelude-val">Some</span>(n_str) =&gt; <span class="kw">match </span>n_str.parse::&lt;u64&gt;() {
            <span class="prelude-val">Ok</span>(n) =&gt; <span class="prelude-val">Some</span>(n),
            <span class="prelude-val">Err</span>(e) =&gt; {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                    <span class="string">&quot;argument for --shuffle-seed must be a number \
                     (error: {})&quot;</span>,
                    e
                ));
            }
        },
        <span class="prelude-val">None </span>=&gt; <span class="prelude-val">None</span>,
    };

    <span class="kw">if </span>shuffle_seed.is_none() &amp;&amp; allow_unstable {
        shuffle_seed = <span class="kw">match </span>env::var(<span class="string">&quot;RUST_TEST_SHUFFLE_SEED&quot;</span>) {
            <span class="prelude-val">Ok</span>(val) =&gt; <span class="kw">match </span>val.parse::&lt;u64&gt;() {
                <span class="prelude-val">Ok</span>(n) =&gt; <span class="prelude-val">Some</span>(n),
                <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="macro">panic!</span>(<span class="string">&quot;RUST_TEST_SHUFFLE_SEED is `{val}`, should be a number.&quot;</span>),
            },
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">None</span>,
        };
    }

    <span class="prelude-val">Ok</span>(shuffle_seed)
}

<span class="kw">fn </span>get_test_threads(matches: <span class="kw-2">&amp;</span>getopts::Matches) -&gt; OptPartRes&lt;<span class="prelude-ty">Option</span>&lt;usize&gt;&gt; {
    <span class="kw">let </span>test_threads = <span class="kw">match </span>matches.opt_str(<span class="string">&quot;test-threads&quot;</span>) {
        <span class="prelude-val">Some</span>(n_str) =&gt; <span class="kw">match </span>n_str.parse::&lt;usize&gt;() {
            <span class="prelude-val">Ok</span>(<span class="number">0</span>) =&gt; <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;argument for --test-threads must not be 0&quot;</span>.to_string()),
            <span class="prelude-val">Ok</span>(n) =&gt; <span class="prelude-val">Some</span>(n),
            <span class="prelude-val">Err</span>(e) =&gt; {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                    <span class="string">&quot;argument for --test-threads must be a number &gt; 0 \
                     (error: {})&quot;</span>,
                    e
                ));
            }
        },
        <span class="prelude-val">None </span>=&gt; <span class="prelude-val">None</span>,
    };

    <span class="prelude-val">Ok</span>(test_threads)
}

<span class="kw">fn </span>get_format(
    matches: <span class="kw-2">&amp;</span>getopts::Matches,
    quiet: bool,
    allow_unstable: bool,
) -&gt; OptPartRes&lt;OutputFormat&gt; {
    <span class="kw">let </span>format = <span class="kw">match </span>matches.opt_str(<span class="string">&quot;format&quot;</span>).as_deref() {
        <span class="prelude-val">None </span><span class="kw">if </span>quiet =&gt; OutputFormat::Terse,
        <span class="prelude-val">Some</span>(<span class="string">&quot;pretty&quot;</span>) | <span class="prelude-val">None </span>=&gt; OutputFormat::Pretty,
        <span class="prelude-val">Some</span>(<span class="string">&quot;terse&quot;</span>) =&gt; OutputFormat::Terse,
        <span class="prelude-val">Some</span>(<span class="string">&quot;json&quot;</span>) =&gt; {
            <span class="kw">if </span>!allow_unstable {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;The \&quot;json\&quot; format is only accepted on the nightly compiler&quot;</span>.into());
            }
            OutputFormat::Json
        }
        <span class="prelude-val">Some</span>(<span class="string">&quot;junit&quot;</span>) =&gt; {
            <span class="kw">if </span>!allow_unstable {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;The \&quot;junit\&quot; format is only accepted on the nightly compiler&quot;</span>.into());
            }
            OutputFormat::Junit
        }
        <span class="prelude-val">Some</span>(v) =&gt; {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;argument for --format must be pretty, terse, json or junit (was \
                 {})&quot;</span>,
                v
            ));
        }
    };

    <span class="prelude-val">Ok</span>(format)
}

<span class="kw">fn </span>get_color_config(matches: <span class="kw-2">&amp;</span>getopts::Matches) -&gt; OptPartRes&lt;ColorConfig&gt; {
    <span class="kw">let </span>color = <span class="kw">match </span>matches.opt_str(<span class="string">&quot;color&quot;</span>).as_deref() {
        <span class="prelude-val">Some</span>(<span class="string">&quot;auto&quot;</span>) | <span class="prelude-val">None </span>=&gt; ColorConfig::AutoColor,
        <span class="prelude-val">Some</span>(<span class="string">&quot;always&quot;</span>) =&gt; ColorConfig::AlwaysColor,
        <span class="prelude-val">Some</span>(<span class="string">&quot;never&quot;</span>) =&gt; ColorConfig::NeverColor,

        <span class="prelude-val">Some</span>(v) =&gt; {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;argument for --color must be auto, always, or never (was \
                 {})&quot;</span>,
                v
            ));
        }
    };

    <span class="prelude-val">Ok</span>(color)
}

<span class="kw">fn </span>get_nocapture(matches: <span class="kw-2">&amp;</span>getopts::Matches) -&gt; OptPartRes&lt;bool&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>nocapture = matches.opt_present(<span class="string">&quot;nocapture&quot;</span>);
    <span class="kw">if </span>!nocapture {
        nocapture = <span class="kw">match </span>env::var(<span class="string">&quot;RUST_TEST_NOCAPTURE&quot;</span>) {
            <span class="prelude-val">Ok</span>(val) =&gt; <span class="kw-2">&amp;</span>val != <span class="string">&quot;0&quot;</span>,
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="bool-val">false</span>,
        };
    }

    <span class="prelude-val">Ok</span>(nocapture)
}

<span class="kw">fn </span>get_run_ignored(matches: <span class="kw-2">&amp;</span>getopts::Matches, include_ignored: bool) -&gt; OptPartRes&lt;RunIgnored&gt; {
    <span class="kw">let </span>run_ignored = <span class="kw">match </span>(include_ignored, matches.opt_present(<span class="string">&quot;ignored&quot;</span>)) {
        (<span class="bool-val">true</span>, <span class="bool-val">true</span>) =&gt; {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;the options --include-ignored and --ignored are mutually exclusive&quot;</span>.into());
        }
        (<span class="bool-val">true</span>, <span class="bool-val">false</span>) =&gt; RunIgnored::Yes,
        (<span class="bool-val">false</span>, <span class="bool-val">true</span>) =&gt; RunIgnored::Only,
        (<span class="bool-val">false</span>, <span class="bool-val">false</span>) =&gt; RunIgnored::No,
    };

    <span class="prelude-val">Ok</span>(run_ignored)
}

<span class="kw">fn </span>get_allow_unstable(matches: <span class="kw-2">&amp;</span>getopts::Matches) -&gt; OptPartRes&lt;bool&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>allow_unstable = <span class="bool-val">false</span>;

    <span class="kw">if let </span><span class="prelude-val">Some</span>(opt) = matches.opt_str(<span class="string">&quot;Z&quot;</span>) {
        <span class="kw">if </span>!is_nightly() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;the option `Z` is only accepted on the nightly compiler&quot;</span>.into());
        }

        <span class="kw">match </span><span class="kw-2">&amp;*</span>opt {
            <span class="string">&quot;unstable-options&quot; </span>=&gt; {
                allow_unstable = <span class="bool-val">true</span>;
            }
            <span class="kw">_ </span>=&gt; {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Unrecognized option to `Z`&quot;</span>.into());
            }
        }
    };

    <span class="prelude-val">Ok</span>(allow_unstable)
}

<span class="kw">fn </span>get_log_file(matches: <span class="kw-2">&amp;</span>getopts::Matches) -&gt; OptPartRes&lt;<span class="prelude-ty">Option</span>&lt;PathBuf&gt;&gt; {
    <span class="kw">let </span>logfile = matches.opt_str(<span class="string">&quot;logfile&quot;</span>).map(|s| PathBuf::from(<span class="kw-2">&amp;</span>s));

    <span class="prelude-val">Ok</span>(logfile)
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="test" data-themes="ayu,dark,light" data-resource-suffix="1.65.0" data-rustdoc-version="1.65.0-dev" ></div></body></html>